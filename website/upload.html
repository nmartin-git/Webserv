<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NiceLife üå≥ ‚Äî Upload</title>
  <link rel="stylesheet" href="/nicelife-style.css">
  <style>
    .upload-panel {
      max-width: 720px;
      margin: 120px auto 80px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 2rem;
      z-index: 20;
      position: relative;
      box-shadow: var(--shadow-md);
    }
    .upload-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .upload-title { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
    .upload-desc { color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.25rem; }

    .drop-zone {
      border: 2px dashed var(--border-green);
      border-radius: 10px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      margin: 1.25rem 0;
    }
    .drop-zone.dragover {
      background: rgba(0,200,100,0.07);
      border-color: var(--accent-green);
      color: var(--accent-green);
    }
    .drop-zone-icon { font-size: 2.5rem; display: block; margin-bottom: 0.5rem; }
    .drop-zone-text { font-size: 1rem; }
    .drop-zone-hint { font-size: 0.8rem; margin-top: 0.4rem; opacity: 0.6; }

    .file-row { display: flex; gap: 1rem; align-items: center; margin: 0.75rem 0; flex-wrap: wrap; }
    .file-label {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      border: 1px solid var(--border-green);
      background: transparent;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.15s;
    }
    .file-label:hover { background: rgba(0,200,100,0.08); }

    .btn-upload {
      padding: 0.6rem 1.4rem;
      background: var(--accent-green);
      color: #000;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: opacity 0.15s;
    }
    .btn-upload[disabled] { opacity: 0.5; cursor: default; }

    .file-info {
      margin-top: 0.5rem;
      padding: 0.6rem 0.9rem;
      background: rgba(255,255,255,0.04);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      display: none;
      align-items: center;
      gap: 0.75rem;
    }
    .file-info.visible { display: flex; }
    .file-info-icon { font-size: 1.6rem; }
    .file-info-name { font-weight: 600; color: var(--text-primary); word-break: break-all; }
    .file-info-size { font-size: 0.82rem; color: var(--text-secondary); }

    .preview-img {
      margin-top: 0.75rem;
      max-width: 100%;
      max-height: 260px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      display: none;
    }

    .progress {
      width: 100%;
      height: 10px;
      background: rgba(255,255,255,0.06);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 1rem;
    }
    .progress > span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-green-light));
      transition: width 0.2s linear;
    }
    .progress-label { font-size: 0.82rem; color: var(--text-secondary); margin-top: 0.25rem; text-align: right; }

    .msg { margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.95rem; }
    .error { color: #ff6b6b !important; }
    .success { color: var(--accent-green) !important; font-weight: 600; }

    .sr-only { position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="logo"><span class="logo-icon">üå≥</span><span class="logo-text">NiceLife</span></div>
      <div class="nav-links">
        <a href="/" class="btn-nav">Accueil</a>
        <a href="/login.py" class="btn-nav">Se connecter</a>
      </div>
    </div>
  </nav>

  <main class="container upload-panel" role="main" aria-labelledby="uploadTitle">
    <div class="upload-header">
      <div>
        <div id="uploadTitle" class="upload-title">Uploader une image</div>
        <div class="upload-desc">PNG, JPG ou JPEG uniquement ‚Äî taille maximale 5 Mo. Aucune ex√©cution c√¥t√© serveur.</div>
      </div>
      <div>
        <a href="/" class="btn-nav">Retour</a>
      </div>
    </div>

    <form id="uploadForm" action="/upload.html" method="post" enctype="multipart/form-data" novalidate>
      <!-- CSRF token: le serveur doit en fournir un et le valider √† la r√©ception -->
      <input type="hidden" name="csrf_token" value="<!-- INSERT_CSRF_TOKEN_SERVER_SIDE -->">

      <div class="drop-zone" id="dropZone" role="button" tabindex="0" aria-label="Zone de d√©p√¥t de fichier">
        <span class="drop-zone-icon">üñºÔ∏è</span>
        <div class="drop-zone-text">Glissez-d√©posez votre image ici</div>
        <div class="drop-zone-hint">ou cliquez pour parcourir (PNG / JPG / JPEG)</div>
      </div>

      <div class="file-row">
        <label class="file-label" for="fileInput">Choisir une image</label>
        <input id="fileInput" name="file" type="file" accept="image/png,image/jpeg,image/jpg,.png,.jpg,.jpeg" class="sr-only" required>
        <button id="submitBtn" class="btn-upload" type="submit" disabled>Uploader</button>
      </div>

      <div class="file-info" id="fileInfo">
        <span class="file-info-icon" id="fileIcon">üñºÔ∏è</span>
        <div>
          <div class="file-info-name" id="fileName"></div>
          <div class="file-info-size" id="fileSize"></div>
        </div>
      </div>
      <img class="preview-img" id="previewImg" alt="Aper√ßu">

      <div class="progress" id="progressWrap" hidden>
        <span id="progressBar" style="width:0%"></span>
      </div>
      <div class="progress-label" id="progressLabel" hidden></div>

      <div class="msg" id="statusMsg" aria-live="polite"></div>
    </form>
  </main>

  <script>
    (function () {
      // ===== RESTRICTIONS DE S√âCURIT√â =====
      const MAX_BYTES = 5 * 1024 * 1024; // 5 MB
      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg']; // PNG, JPG et JPEG accept√©s

      const fileInput    = document.getElementById('fileInput');
      const submitBtn    = document.getElementById('submitBtn');
      const dropZone     = document.getElementById('dropZone');
      const fileInfo     = document.getElementById('fileInfo');
      const fileName     = document.getElementById('fileName');
      const fileSize     = document.getElementById('fileSize');
      const fileIcon     = document.getElementById('fileIcon');
      const previewImg   = document.getElementById('previewImg');
      const progressWrap = document.getElementById('progressWrap');
      const progressBar  = document.getElementById('progressBar');
      const progressLabel = document.getElementById('progressLabel');
      const statusMsg    = document.getElementById('statusMsg');
      const form         = document.getElementById('uploadForm');

      // ===== V√âRIFICATION DES MAGIC BYTES (anti-spoofing) =====
      function checkMagicBytes(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          const slice = file.slice(0, 8);
          reader.onload = function(e) {
            const arr = new Uint8Array(e.target.result);
            // PNG signature: 89 50 4E 47 0D 0A 1A 0A
            const pngSig = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
            // JPEG signature: FF D8 FF (les 3 premiers octets)
            if (arr.length >= 3 && arr[0] === 0xFF && arr[1] === 0xD8 && arr[2] === 0xFF) {
              resolve('image/jpeg');
              return;
            }
            if (arr.length >= 8 && pngSig.every((b, i) => arr[i] === b)) {
              resolve('image/png');
              return;
            }
            resolve(null);
          };
          reader.onerror = function() { reject(new Error('Lecture du fichier impossible')); };
          reader.readAsArrayBuffer(slice);
        });
      }

      function fmtSize(bytes) {
        if (bytes < 1024) return bytes + ' o';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' Ko';
        if (bytes < 1073741824) return (bytes / 1048576).toFixed(2) + ' Mo';
        return (bytes / 1073741824).toFixed(2) + ' Go';
      }

      function resetUI() {
        fileInfo.classList.remove('visible');
        previewImg.style.display = 'none';
        previewImg.src = '';
        submitBtn.disabled = true;
        statusMsg.textContent = '';
        statusMsg.className = 'msg';
        progressWrap.hidden = true;
        progressBar.style.width = '0%';
        progressLabel.hidden = true;
      }

      // ===== VALIDATION S√âCURIS√âE DU FICHIER =====
      function validateAndSetFile(file) {
        if (!file) return;

        resetUI();

        // V√©rification 1 : Taille maximale
        if (file.size > MAX_BYTES) {
          statusMsg.textContent = '‚ùå Fichier trop volumineux (max 5 Mo).';
          statusMsg.className = 'msg error';
          fileInput.value = '';
          return;
        }

        // V√©rification 2 : Extension du fichier (v√©rification basique)
        const fileExt = file.name.split('.').pop().toLowerCase();
        const allowedExtensions = ['png', 'jpg', 'jpeg'];
        if (!allowedExtensions.includes(fileExt)) {
          statusMsg.textContent = '‚ùå Extension non autoris√©e. Seuls PNG, JPG et JPEG sont accept√©s.';
          statusMsg.className = 'msg error';
          fileInput.value = '';
          return;
        }

        // V√©rification 3 : Type MIME (peut √™tre spoof√©, d'o√π la v√©rification suivante)
        const mimeOk = allowedTypes.includes(file.type) || file.type === '';
        if (!mimeOk) {
          statusMsg.textContent = '‚ö†Ô∏è Type MIME suspect ‚Äî v√©rification binaire en cours...';
          statusMsg.className = 'msg error';
        }

        // V√©rification 4 : Magic bytes (signature binaire - protection anti-spoofing)
        checkMagicBytes(file).then(sig => {
          if (!sig) {
            statusMsg.textContent = '‚ùå Type de fichier invalide (signature binaire incompatible).';
            statusMsg.className = 'msg error';
            fileInput.value = '';
            return;
          }
          if (sig !== 'image/png' && sig !== 'image/jpeg') {
            statusMsg.textContent = '‚ùå Format non autoris√©. Seuls PNG, JPG et JPEG sont accept√©s.';
            statusMsg.className = 'msg error';
            fileInput.value = '';
            return;
          }

          // Fichier valide : affichage des informations
          fileName.textContent = file.name;
          fileSize.textContent = fmtSize(file.size) + '  ‚Ä¢  ' + (sig === 'image/jpeg' ? 'JPG/JPEG' : 'PNG');
          fileIcon.textContent = 'üñºÔ∏è';
          fileInfo.classList.add('visible');

          // Pr√©visualisation
          previewImg.src = URL.createObjectURL(file);
          previewImg.style.display = 'block';

          submitBtn.disabled = false;
          statusMsg.textContent = '‚úÖ Fichier pr√™t : ' + file.name + ' (' + Math.round(file.size / 1024) + ' Ko)';
          statusMsg.className = 'msg success';
        }).catch(err => {
          statusMsg.textContent = '‚ùå Erreur lors de la v√©rification du fichier.';
          statusMsg.className = 'msg error';
          fileInput.value = '';
        });
      }

      // ===== GESTION DES √âV√âNEMENTS =====
      fileInput.addEventListener('change', function () {
        if (fileInput.files[0]) validateAndSetFile(fileInput.files[0]);
      });

      dropZone.addEventListener('dragover', function (e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', function () {
        dropZone.classList.remove('dragover');
      });
      dropZone.addEventListener('drop', function (e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const f = e.dataTransfer.files[0];
        if (f) {
          try { const dt = new DataTransfer(); dt.items.add(f); fileInput.files = dt.files; } catch (_) {}
          validateAndSetFile(f);
        }
      });
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
      });

      document.querySelector('.file-label').addEventListener('click', () => fileInput.click());

      // ===== SOUMISSION S√âCURIS√âE DU FORMULAIRE =====
      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const f = fileInput.files[0];
        if (!f) {
          statusMsg.textContent = '‚ùå Veuillez choisir un fichier.';
          statusMsg.className = 'msg error';
          return;
        }

        // Re-validation avant envoi
        if (f.size > MAX_BYTES) {
          statusMsg.textContent = '‚ùå Fichier trop volumineux (max 5 Mo).';
          statusMsg.className = 'msg error';
          return;
        }

        checkMagicBytes(f).then(sig => {
          if (!sig || (sig !== 'image/png' && sig !== 'image/jpeg')) {
            statusMsg.textContent = '‚ùå Format de fichier non autoris√©.';
            statusMsg.className = 'msg error';
            return;
          }

          // Construction des donn√©es avec CSRF token
          const formData = new FormData();
          formData.append('file', f);
          const csrf = form.querySelector('input[name="csrf_token"]');
          if (csrf && csrf.value) formData.append('csrf_token', csrf.value);

          // D√©sactivation de l'interface pendant l'envoi
          submitBtn.disabled = true;
          fileInput.disabled = true;
          progressWrap.hidden = false;
          progressLabel.hidden = false;
          progressBar.style.width = '0%';
          progressLabel.textContent = '0 %';
          statusMsg.textContent = 'Envoi en cours‚Ä¶';
          statusMsg.className = 'msg';

          const xhr = new XMLHttpRequest();
          xhr.open('POST', form.action, true);
          xhr.setRequestHeader('Accept', 'application/json');

          xhr.upload.onprogress = function (ev) {
            if (ev.lengthComputable) {
              const p = Math.round(ev.loaded / ev.total * 100);
              progressBar.style.width = p + '%';
              progressLabel.textContent = p + ' %  (' + fmtSize(ev.loaded) + ' / ' + fmtSize(ev.total) + ')';
            }
          };

          xhr.onload = function () {
            submitBtn.disabled = false;
            fileInput.disabled = false;
            if (xhr.status >= 200 && xhr.status < 300) {
              progressBar.style.width = '100%';
              progressLabel.textContent = '100 %';
              statusMsg.textContent = '‚úÖ Image upload√©e avec succ√®s : ' + f.name;
              statusMsg.className = 'msg success';
              // Optionnel : afficher l'URL de l'image upload√©e
              try {
                const json = JSON.parse(xhr.responseText || '{}');
                if (json.url) {
                  statusMsg.innerHTML += ' ‚Äî <a href="' + json.url + '" target="_blank" style="color:var(--accent-green);text-decoration:underline;">Voir l\'image</a>';
                }
              } catch (e) { /* ignore non-json */ }
            } else if (xhr.status === 401) {
              statusMsg.textContent = 'üîí Connexion requise pour uploader un fichier.';
              statusMsg.className = 'msg error';
            } else {
              statusMsg.textContent = '‚ùå Erreur serveur : ' + xhr.status;
              statusMsg.className = 'msg error';
            }
          };

          xhr.onerror = function () {
            submitBtn.disabled = false;
            fileInput.disabled = false;
            statusMsg.textContent = '‚ùå Erreur r√©seau durant l\'upload.';
            statusMsg.className = 'msg error';
          };

          xhr.send(formData);
        }).catch(err => {
          statusMsg.textContent = '‚ùå Erreur lors de la v√©rification du fichier.';
          statusMsg.className = 'msg error';
        });
      });

    })();
  </script>
</body>
</html>
